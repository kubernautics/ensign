#!/bin/ansible-playbook
- name: MSIO | Ensign | https://github.com/ministackio/ensign
  hosts: localhost
  become: yes
  connection: local
  vars_files:
    - vars/custom.yml
    - vars/main.yml
  tasks:
    - name: MSIO | Ensign | Update Packages
      package:
        name: "*"
        state: latest
    - name: MSIO | Ensign | Install Packages
      package:
        name: "{{ packages_base_ubuntu }}"
        state: present
    - name: MSIO | Ensign | Create Group 'CCIO'
      group:
        name: ccio
        gid: 7000
        state: present
    - name: MSIO | Ensign | Assets | Chown Assets with 'CCIO' Group
      file:
        dest: /root/.ccio/ocp-mini-stack/module
        owner: root
        group: ccio
        mode: '1664'
        recurse: yes
    - file:
        dest: ~/openwrt/config
        owner: root
        group: ccio
        mode: '1664'
        recurse: yes
#   - name: MSIO | Ensign | Assets | Build Config From Templates
#     template:
#       src: '{{ item.src }}'
#       dest: ~/openwrt/config/{{ item.path }}
#       mode: '{{ item.mode }}'
#     with_filetree: templates/openwrt/
#     when: item.state == 'file'
    - name: Write Networkd OVS Bridge Configuration
      template:
        src: "{{ item }}.network"
        dest: "/etc/systemd/network/{{ item }}.network"
      with_items:
        - mgmt0
        - internal
    - name: Enable & Start Networkd + OpenVSwitch
      service:
        name: "{{ item }}"
        enabled: yes
      with_items:
        - network
        - openvswitch-switch
    - name: Networking | OpenVSwitch | Build Bridge Internal
      openvswitch_bridge:
        bridge: internal
        state: present
    - name: Gateway - Build Profile
      lxd_profile:
        name: openwrt
        state: present
        config: 
          linux.kernel_modules: ip6table_filter,iptable_filter,wireguard,ip6_udp_tunnel,udp_tunnel
          security.privileged: "true"
          boot.autostart: "true"
        devices:
          eth0:
            name: eth0
            nictype: bridged
            parent: lxdbr0
            type: nic
          eth1:
            name: eth1
            nictype: bridged
            parent: internal
            type: nic
          root:
            path: /
            pool: default
            type: disk
          openwrt-config:
            source: /home/kmorgan/openwrt/config
            path: /etc/config
            type: disk
