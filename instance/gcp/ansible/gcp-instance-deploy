#!/bin/ansible-playbook
- name: MSIO | Ensign | Terraform Deploy
  hosts: localhost
  vars_files:
    - vars/custom.yml
    - vars/main.yml
  tasks:
    - name: MSIO | Ensign | Detect RunAs User
      become: false
      local_action: command whoami
      register: ansible_user_connected

    - name: MSIO | Ensign | purge known_hosts
      lineinfile:
        path: "/home/{{ ansible_user_connected }}/.ssh/known_hosts"
        regexp: 'ensign'
        state: absent

    - name: MSIO | Ensign | GCP | DNS | write state template
      template:
        src: "templates/tf/instance/terraform.tfstate.j2"
        dest: "/home/{{ ansible_user_connected.stdout }}/.ccio/ensign/instance/gcp/ansible/tf/instance/state.tf"
        owner: "{{ ansible_user_connected.stdout }}"
        group: "ccio"
        mode: '755'

    - name: MSIO | Ensign | GCP | Terraform Init
      shell: terraform init
      args:
        chdir: 'tf/instance/'

    - name: MSIO | Ensign | GCP | Import ensign public IP `ensign_public_ipv4`
      shell: terraform import google_compute_address.ensign_public_ipv4 projects/ministackdev/regions/us-west3/addresses/ensign-public-ipv4
      args:
        chdir: 'tf/instance/'
      ignore_errors: True
      register: ensign_public_ipv4
    - debug: var=ensign_public_ipv4

    - name: MSIO | Ensign | GCP | Build Instance
      terraform:
        project_path: 'tf/instance/'
       #variables_file: "../../vars/variables.tf"
        state: present
        force_init: true
